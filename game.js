const table = {
    "different": {
      "17": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "18": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "19": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "20": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "21": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "13": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "14": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "15": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "16": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "12": {
        "2": 1, "3": 1, "4": 0, "5": 0, "6": 0, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "11": {
        "2": 2, "3": 2, "4": 2, "5": 2, "6": 2, "7": 2, "8": 2, "9": 2,
        "10": 2, "11": 2, "12": 2, "13": 2, "1": 1
      },
      "10": {
        "2": 2, "3": 2, "4": 2, "5": 2, "6": 2, "7": 2, "8": 2, "9": 2,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "9": {
        "2": 1, "3": 2, "4": 2, "5": 2, "6": 1, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "5": {
        "2": 1, "3": 1, "4": 1, "5": 1, "6": 1, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "6": {
        "2": 1, "3": 1, "4": 1, "5": 1, "6": 1, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "7": {
        "2": 1, "3": 1, "4": 1, "5": 1, "6": 1, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "8": {
        "2": 1, "3": 1, "4": 1, "5": 1, "6": 1, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      }
    },
    "as": {
      "8": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "9": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "10": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "7": {
        "2": 0, "3": 2, "4": 2, "5": 2, "6": 2, "7": 0, "8": 0, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "6": {
        "2": 1, "3": 2, "4": 2, "5": 2, "6": 2, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "4": {
        "2": 1, "3": 1, "4": 2, "5": 2, "6": 2, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "5": {
        "2": 1, "3": 1, "4": 2, "5": 2, "6": 2, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "2": {
        "2": 1, "3": 1, "4": 1, "5": 2, "6": 2, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "3": {
        "2": 1, "3": 1, "4": 1, "5": 2, "6": 2, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      }
    },
    "pair": {
      "1": {
        "2": 3, "3": 3, "4": 3, "5": 3, "6": 3, "7": 3, "8": 3, "9": 3,
        "10": 3, "11": 3, "12": 3, "13": 3, "1": 3
      },
      "10": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "11": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "12": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "13": {
        "2": 0, "3": 0, "4": 0, "5": 0, "6": 0, "7": 0, "8": 0, "9": 0,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "9": {
        "2": 3, "3": 3, "4": 3, "5": 3, "6": 3, "7": 0, "8": 3, "9": 3,
        "10": 0, "11": 0, "12": 0, "13": 0, "1": 0
      },
      "8": {
        "2": 3, "3": 3, "4": 3, "5": 3, "6": 3, "7": 3, "8": 3, "9": 3,
        "10": 3, "11": 3, "12": 3, "13": 3, "1": 3
      },
      "7": {
        "2": 3, "3": 3, "4": 3, "5": 3, "6": 3, "7": 3, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "6": {
        "2": 3, "3": 3, "4": 3, "5": 3, "6": 3, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "5": {
        "2": 2, "3": 2, "4": 2, "5": 2, "6": 2, "7": 2, "8": 2, "9": 2,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "4": {
        "2": 1, "3": 1, "4": 1, "5": 3, "6": 3, "7": 1, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "3": {
        "2": 3, "3": 3, "4": 3, "5": 3, "6": 3, "7": 3, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      },
      "2": {
        "2": 3, "3": 3, "4": 3, "5": 3, "6": 3, "7": 3, "8": 1, "9": 1,
        "10": 1, "11": 1, "12": 1, "13": 1, "1": 1
      }
    }
  }
    

export const cards = {
    1: {name: 'as', value: [1,11]},
    2: {name: '2', value: [2]}, 
    3: {name: '2', value: [3]},
    4: {name: '2', value: [4]},
    5: {name: '2', value: [5]},
    6: {name: '2', value: [6]},
    7: {name: '2', value: [7]},
    8: {name: '2', value: [8]},
    9: {name: '2', value: [9]},
    10: {name: '2', value: [10]},
    11: {name: '2', value: [10]},
    12: {name: '2', value: [10]},
    13: {name: '2', value: [10]},
}

export const actions = {
    0: 'Stop', 1: 'Take', 2: 'Double', 3: 'Sepair'
}

export class Game {
    constructor(bet=null,player=null,dealer=null){
        this.player = (player != null) ? player : this.getRandomCards(2)
        this.dealer = (dealer != null) ? dealer : this.getRandomCards(1)
        this.player_deck2 = null

        this.dealer_value = this.getCount([this.dealer[0]])
        this.player_value = this.getCount(this.player)

        this.bet = bet
        this.bet2 = bet.valueOf()
    }

    getActionFromTable(deck, deck_value) {
        if(deck.length == 2) {
            if(deck[0] == deck[1]) {
                return table['pair'][deck[0].toString()][this.dealer_value.toString()]
            } else if((deck[0] == 1 || deck[1] == 1) && deck[0] != deck[1]) {
                const other_card = (deck[0] == 1) ? 1 : 0
                return table['as'][cards[deck[other_card]].value[0].toString()][this.dealer_value.toString()]
            } else {
                return table['different'][deck_value.toString()][this.dealer_value.toString()]
            }
        } else {
            return table['different'][deck_value.toString()][this.dealer_value.toString()]
        }
    }

    isBlackjack(deck) {
        return (this.getCount([deck[0], deck[1]]) == 21)
    }

    getCount(deck) {
        var s=0
        for (const el of deck) {
            if(el != 1) {
                s=s+cards[el].value[0]
            }
        }
        for (const el of deck) {
            if(el == 1) {
                if(s + cards[el].value[1] <= 21) {
                    s=s+cards[el].value[1]
                } else {
                    s=s+cards[el].value[0]
                }
            }
        }
        return s
    }

    getRandomCards(n) {
        const deck = []
        for (let i =0; i<n;i++){
            deck.push(this.randomIntFromInterval(1,13))
        }
        return deck
    }
    
    randomIntFromInterval(min, max) {
        return Math.floor(Math.random() * (max - min + 1) + min);
    }

    take() {
        const new_card = this.randomIntFromInterval(1,13)
        this.player.push(new_card)
        this.player_value = this.getCount(this.player)
    }

    takeDeck2() {
        const new_card = this.randomIntFromInterval(1,13)
        this.player_deck2.push(new_card)
        this.player_deck2_value = this.getCount(this.player_deck2)
    }

    doDealer() {
        this.dealer_value = this.getCount(this.dealer)
        while(this.dealer_value < 17) {
            const new_card = this.randomIntFromInterval(1,13)
            this.dealer.push(new_card)
            this.dealer_value = this.getCount(this.dealer)
        }
    }

    winner(deck, deck_value, bet) {
        const player_blackjack = this.isBlackjack(deck)
        const dealer_blackjack = this.isBlackjack(this.dealer)

        if (deck_value > 21) {
            return -bet
        } 
        if(this.dealer_value > 21) {
            return bet
        }
            
        if(deck_value < this.dealer_value) {
            return -bet
        }
        if(!player_blackjack && dealer_blackjack) {
            return -bet
        }

        if(player_blackjack && !dealer_blackjack) {
          return bet * (3/2)
        }

        if(player_blackjack && dealer_blackjack) {
            return 0
        }
        if(deck_value == this.dealer_value) {
            return 0
        }

        if(deck_value > this.dealer_value) {
            return bet
        }
    }

    stop() {
        this.doDealer()
        this.bet = this.winner(this.player, this.player_value, this.bet)
        if(this.player_deck2 != null) {
            this.bet2 = this.winner(this.player_deck2, this.player_deck2_value, this.bet2)
            this.bet2 = (this.bet2 > 0) ? this.bet2 : 0
            return this.bet + this.bet2
        }
        return this.bet
    }

    play() {
        var action = this.getActionFromTable(this.player, this.player_value)
        while(this.player_value <= 21 && action!=0) {
            if(action == 1) {
                this.take()
            } else if (action == 2){
                this.bet = this.bet * 2
                this.take()
                break
            } else if(action == 0) {
                break
            } else if(action == 3 && this.player_deck2 == null) {
                this.player = [this.player[0], this.randomIntFromInterval(1,13)]
                this.player_deck2 = [this.player[0], this.randomIntFromInterval(1,13)]
                this.player_deck2_value = this.getCount(this.player_deck2)

                this.take()
            }

            if(this.player_value <= 21) {
                action = this.getActionFromTable(this.player, this.player_value)
            } else {
                break
            }
        }

        if(this.player_deck2 != null) {
            var action = this.getActionFromTable(this.player_deck2, this.player_deck2_value)
            while(this.player_deck2_value <= 21 && action!=0) {
                if(action == 1) {
                    this.takeDeck2()
                } else if (action == 2){
                    this.bet2 = this.bet2 * 2
                    this.takeDeck2()
                    break
                } else if(action == 0) {
                    break
                } else if(action == 3) {
                    this.takeDeck2()
                }
    
                if(this.player_deck2_value <= 21) {
                    action = this.getActionFromTable(this.player_deck2, this.player_deck2_value)
                } else {
                    break
                }
            }
        }

        return this.stop()
    }
}